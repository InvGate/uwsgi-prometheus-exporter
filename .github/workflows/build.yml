name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      uwsgi_version:
        description: 'uWSGI version/tag to build against (e.g., 2.0.23 or "latest")'
        required: false
        default: 'latest'

env:
  UWSGI_VERSION: ${{ github.event.inputs.uwsgi_version || 'latest' }}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout plugin repository
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          python3 \
          python3-dev \
          libpcre3-dev \
          libssl-dev \
          zlib1g-dev \
          libxml2-dev \
          libyaml-dev \
          curl \
          wget

    - name: Install promtool for Prometheus validation
      run: |
        PROMTOOL_VERSION="2.48.1"
        wget -q https://github.com/prometheus/prometheus/releases/download/v${PROMTOOL_VERSION}/prometheus-${PROMTOOL_VERSION}.linux-amd64.tar.gz
        tar xzf prometheus-${PROMTOOL_VERSION}.linux-amd64.tar.gz
        sudo cp prometheus-${PROMTOOL_VERSION}.linux-amd64/promtool /usr/local/bin/
        promtool --version

    - name: Run CI build and test script
      run: |
        export PLUGIN_DIR="${GITHUB_WORKSPACE}"
        export WORK_DIR="${GITHUB_WORKSPACE}/build"
        export UWSGI_VERSION="${{ env.UWSGI_VERSION }}"
        mkdir -p "${WORK_DIR}"

        ./ci-build-and-test.sh

    - name: Upload compiled plugin
      uses: actions/upload-artifact@v4
      with:
        name: metrics_prometheus-plugin
        path: build/uwsgi/metrics_prometheus.so
        if-no-files-found: error

    - name: Display plugin info
      run: |
        cd build/uwsgi
        echo "âœ… Build successful!"
        echo ""
        echo "Plugin: metrics_prometheus.so"
        echo "Size: $(du -h metrics_prometheus.so | cut -f1)"
        echo "Type: $(file metrics_prometheus.so)"
        echo ""
        echo "Download the artifact from the Actions tab to use this plugin."
